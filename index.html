<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento en Tiempo Real</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 500px; width: 100%; }
    .container { margin: 20px; }
    .info { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Seguimiento en Tiempo Real</h1>
    <input type="text" id="destino" placeholder="Ingresa el lugar de destino en Bariloche" class="form-control" />
    <button onclick="compartirPorWhatsApp()">Compartir mi recorrido por WhatsApp</button>
    <span id="distancia" class="info"></span>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-41.1335, -71.3103], 13); // Centro en Bariloche

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let markerCurrentPosition = L.marker([-41.1335, -71.3103]).addTo(map);
    let markerDestination = L.marker([-41.1335, -71.3103]).addTo(map);
    let polyline = L.polyline([], { color: 'blue' }).addTo(map);
    let distanceSpan = document.getElementById('distancia');
    let watchId;

    function updatePosition(position) {
      const { latitude, longitude } = position.coords;
      markerCurrentPosition.setLatLng([latitude, longitude]);
      map.setView([latitude, longitude]);

      if (polyline.getLatLngs().length > 0) {
        polyline.addLatLng([latitude, longitude]);
      } else {
        polyline.setLatLngs([[latitude, longitude]]);
      }

      calculateDistance();
    }

    function onError(error) {
      console.error('Error en la ubicación:', error);
    }

    function calculateDistance() {
      const currentLatLng = markerCurrentPosition.getLatLng();
      const destinationLatLng = markerDestination.getLatLng();

      const distance = currentLatLng.distanceTo(destinationLatLng);
      distanceSpan.textContent = `Distancia restante: ${Math.round(distance)} metros`;

      // Actualizar la distancia en tiempo real
      setTimeout(calculateDistance, 1000);
    }

    function setDestination() {
      const destino = document.getElementById('destino').value;
      if (!destino) return;

      fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(destino)}, Bariloche&format=json`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            const { lat, lon } = data[0];
            markerDestination.setLatLng([lat, lon]);
            map.setView([lat, lon]);

            calculateDistance();
          } else {
            alert('No se encontró el destino.');
          }
        });
    }

    function compartirPorWhatsApp() {
      const nombre = prompt('Ingresa tu nombre:');
      if (!nombre) return;

      const url = window.location.href;
      const mensaje = `Soy ${nombre}, estoy yendo hacia el destino. Mi recorrido actual: ${url}`;
      const telefono = prompt('Ingresa el número de teléfono para compartir por WhatsApp (con código de país):');
      
      if (telefono) {
        const enlace = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
        window.open(enlace, '_blank');
      }
    }

    document.getElementById('destino').addEventListener('change', setDestination);

    if (navigator.geolocation) {
      watchId = navigator.geolocation.watchPosition(updatePosition, onError, { enableHighAccuracy: true });
    } else {
      alert('La geolocalización no está soportada en este navegador.');
    }
  </script>
</body>
</html>
